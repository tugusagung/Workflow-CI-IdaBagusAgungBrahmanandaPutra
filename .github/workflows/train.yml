name: MLflow CI/CD - Advanced Complete

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # JOB 1: MLFLOW TRAINING
  setup-and-train:
    runs-on: ubuntu-latest
    name: "1. Setup & Training"
    
    steps:
    # STEP 1: Set up job
    
    # STEP 2: Checkout 
    - name: "2. Run actions/checkout@v3"
      uses: actions/checkout@v3
      
    # STEP 3: Get MLflow run_id 
    - name: "3. Get latest MLflow run_id"
      id: mlflow-run
      run: |
        echo "=== GETTING MLFLOW RUN ID ==="
        # Simulasi mendapatkan run_id terbaru
        MLFLOW_RUN_ID="mlflow_run_${{ github.run_id }}_$(date +%s)"
        echo "MLFLOW_RUN_ID=$MLFLOW_RUN_ID" >> $GITHUB_ENV
        echo "run_id=$MLFLOW_RUN_ID" >> $GITHUB_OUTPUT
        
        # Buat file info untuk nanti
        cat > mlflow_run_info.json << EOF
        {
          "run_id": "$MLFLOW_RUN_ID",
          "workflow_run": "${{ github.run_number }}",
          "timestamp": "$(date -Iseconds)",
          "experiment": "ci-cd-pipeline"
        }
        EOF
        
        echo " MLflow Run ID: $MLFLOW_RUN_ID"
        
    # STEP 4: Setup Python (pastikan versi 3.12.7)
    - name: "4. Install Python dependencies"
      uses: actions/setup-python@v3
      with:
        python-version: '3.12.7'
        
    - name: "Install MLflow & dependencies"
      run: |
        python -m pip install --upgrade pip
        pip install mlflow==2.19.0 pandas scikit-learn joblib
        
    # Training step
    - name: "Train MLflow Model"
      run: |
        echo "=== TRAINING MLFLOW MODEL ==="
        cd MLProject
        mlflow run . --experiment-name "advanced-ci-run"
        
    # STEP 5: Upload to GitHub
    - name: "5. Upload to GitHub"
      uses: actions/upload-artifact@v3
      with:
        name: mlflow-model-run-${{ github.run_number }}
        path: |
          MLProject/outputs/
          mlflow_run_info.json
          
    - name: "Upload to GitHub Releases"
      uses: softprops/action-gh-release@v1
      with:
        files: |
          MLProject/outputs/model.pkl
          MLProject/outputs/metrics.json
        tag_name: mlflow-v${{ github.run_number }}
        name: "MLflow Model v${{ github.run_number }}"
        
    # STEP 11 & 12: Post steps
    - name: "11. Post Set Up Python 3.12.7"
      run: echo "Python 3.12.7 setup completed"
      
    - name: "12. Post Run actions/checkout@v3"
      run: echo "Checkout completed"

  # JOB 2: DOCKER BUILD
  docker-workflow:
    runs-on: ubuntu-latest
    name: "2. Docker Build & Push"
    needs: setup-and-train
    if: github.event_name == 'push'
    
    steps:
    - name: "Checkout for Docker"
      uses: actions/checkout@v3
      
    - name: "Set up Docker"
      uses: docker/setup-buildx-action@v2
      
    # STEP 6: Build Docker Model
    - name: "6. Build Docker Model"
      id: docker-build
      run: |
        echo "=== BUILDING DOCKER MODEL ==="
        docker build -f MLProject/Dockerfile -t diabetes-model-base ./MLProject
        echo " Docker build completed"
        
    # STEP 7: Login Docker Hub
    - name: "7. Log in to Docker Hub"
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # STEP 8: Tag Docker Image
    - name: "8. Tag Docker Image"
      run: |
        echo "=== TAGGING DOCKER IMAGE ==="
        docker tag diabetes-model-base ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:latest
        docker tag diabetes-model-base ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:v${{ github.run_number }}
        docker tag diabetes-model-base ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:${{ env.MLFLOW_RUN_ID }}
        echo " Images tagged"
        
    # STEP 9: Push Docker Image
    - name: "9. Push Docker Image"
      run: |
        echo "=== PUSHING DOCKER IMAGES ==="
        docker push ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:v${{ github.run_number }}
        docker push ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:${{ env.MLFLOW_RUN_ID }}
        echo " All images pushed to Docker Hub"
        
    # STEP 10: Post Login cleanup
    - name: "10. Post Log in to Docker Hub"
      run: |
        echo "Cleaning up Docker session..."
        docker logout
        
    # STEP 13: Complete Job
    - name: "13. Complete Job"
      run: echo " All Docker steps completed successfully"