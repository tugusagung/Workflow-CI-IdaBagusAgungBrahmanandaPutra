name: MLflow CI/CD Pipeline - Advanced

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      experiment_name:
        description: 'MLflow experiment name'
        required: false
        default: 'manual-run'

jobs:
  mlflow-training:
    runs-on: ubuntu-latest
    name: MLflow Model Training
    
    # 1. Set up job (otomatis oleh GitHub)
    
    steps:
    # 2. Run actions/checkout@v3 (sekarang @v4)
    - name: Checkout repository
      uses: actions/checkout@v4
      id: checkout-step
      
    # 3. Get latest MLflow run_id (KITA TAMBAHKAN)
    - name: Get environment info
      id: env-info
      run: |
        echo "GITHUB_SHA=$GITHUB_SHA" >> $GITHUB_ENV
        echo "GITHUB_RUN_NUMBER=$GITHUB_RUN_NUMBER" >> $GITHUB_ENV
        echo "RUN_ID=run-$GITHUB_RUN_NUMBER" >> $GITHUB_ENV
        
    # 4. Install Python dependencies
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mlflow==2.19.0 pandas scikit-learn joblib
        
    # Run MLflow training
    - name: Train model with MLflow
      id: mlflow-train
      run: |
        echo " Running MLflow Project..."
        cd MLProject
        
        # Run MLflow project
        mlflow run . \
          --experiment-name github-ci-run-${{ github.run_number }} \
          --param-list n_estimators=150 \
          --param-list max_depth=15
        
        # Get the latest run info (simulasi)
        echo "MLFLOW_RUN_ID=run_${{ github.run_number }}_$(date +%s)" >> $GITHUB_ENV
        
    # 5. Upload to GitHub (GANTI "Upload to Google Drive")
    - name: Upload artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-model-artifacts
        path: |
          MLProject/outputs/
        retention-days: 30
      
    # Upload to GitHub Releases juga
    - name: Upload to GitHub Releases
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          MLProject/outputs/model.pkl
          MLProject/outputs/metrics.json
          MLProject/outputs/run_info.json
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }} - MLflow Model
        body: |
          Automated MLflow Model Training - Run #${{ github.run_number }}
          
          **Generated Files:**
          - `model.pkl`: Trained RandomForest model
          - `metrics.json`: Model performance metrics
          - `run_info.json`: Training metadata
          
          **MLflow Project:** diabetes-prediction-project
          **Trigger:** ${{ github.event_name }}
          **Commit:** ${{ github.sha }}
          
    - name: Create training summary
      run: |
        echo "##  MLflow Training Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "###  Training Completed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Run Number: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Artifacts Uploaded to:**" >> $GITHUB_STEP_SUMMARY
        echo "1. **GitHub Actions Artifacts** (mlflow-model-artifacts)" >> $GITHUB_STEP_SUMMARY
        echo "2. **GitHub Releases** (v${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Step:** Docker image build" >> $GITHUB_STEP_SUMMARY

  # --- DOCKER BUILD JOB ---
  docker-build:
    runs-on: ubuntu-latest
    name: Build Docker Image
    needs: mlflow-training  # Tunggu training selesai
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    # 6. Build Docker Model
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    # 7. Log in to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # 8. Tag Docker Image
    - name: Prepare Docker tags
      id: docker-tags
      run: |
        echo "TAGS=${{ secrets.DOCKER_USERNAME }}/diabetes-ml-project:latest,${{ secrets.DOCKER_USERNAME }}/diabetes-ml-project:v${{ github.run_number }}" >> $GITHUB_ENV
        echo "tags=${{ secrets.DOCKER_USERNAME }}/diabetes-ml-project:latest,${{ secrets.DOCKER_USERNAME }}/diabetes-ml-project:v${{ github.run_number }}" >> $GITHUB_OUTPUT
        
    # 9. Push Docker Image
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: ./MLProject
        file: ./MLProject/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-project:latest
          ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-project:v${{ github.run_number }}
        labels: |
          org.opencontainers.image.source=${{ github.repositoryUrl }}
          org.opencontainers.image.description="Diabetes ML Model - MLflow Project"
          org.opencontainers.image.version=v${{ github.run_number }}
        
    # 10. Post Log in to Docker Hub (cleanup)
    - name: Logout from Docker Hub
      if: always()
      run: docker logout
      
    - name: Docker build summary
      run: |
        echo "## Docker Image Built" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Docker image successfully built and pushed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tags:**" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ secrets.DOCKER_USERNAME }}/diabetes-ml-project:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ secrets.DOCKER_USERNAME }}/diabetes-ml-project:v${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Available at:**" >> $GITHUB_STEP_SUMMARY
        echo "https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/diabetes-ml-project" >> $GITHUB_STEP_SUMMARY
        
    # 11. Post Set Up Python 3.12.7 (tidak ada step khusus, sudah di job pertama)
    # 12. Post Run actions/checkout@v3 (tidak ada step khusus)
    
  # 13. Complete Job (otomatis)