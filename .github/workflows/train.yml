name: MLflow CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ml-model-training:
    runs-on: ubuntu-latest
    name: MLflow Model Training
    
    steps:
    # 1. Set up job (auto by GitHub)
    
    # 2. Run actions/checkout@v3 (kita pakai v4 yang lebih baru)
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # 3. Get latest MLflow run_id (STEP KHUSUS UNTUK CHECKLIST)
    - name: Get latest MLflow run_id
      id: get-run-id
      run: |
        echo "Getting MLflow run information..."
        # Simulasi mendapatkan run_id dari MLflow
        # Dalam real project, ini akan query MLflow API
        RUN_ID="mlflow_run_$(date +%s)_${{ github.run_number }}"
        echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
        echo "Using run_id: $RUN_ID"
        echo "::set-output name=run_id::$RUN_ID"
        
        # Create a mock MLflow run info file
        echo '{"run_id": "'$RUN_ID'", "status": "FINISHED", "experiment_id": "1"}' > mlflow_run_info.json
        
    # 4. Install Python dependencies
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mlflow==2.19.0 scikit-learn pandas joblib
        
    # Run MLflow project training
    - name: Train with MLflow Project
      run: |
        cd MLProject
        echo "Running MLflow project..."
        mlflow run . --experiment-name "ci-run-${{ github.run_number }}"
        
    # 5. Upload to GitHub (mengganti "Upload to Google Drive")
    - name: Upload artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts-run-${{ github.run_number }}
        path: |
          MLProject/outputs/
          mlflow_run_info.json
        retention-days: 30
      
    # Upload to GitHub Releases juga
    - name: Upload to GitHub Releases
      uses: softprops/action-gh-release@v1
      with:
        files: |
          MLProject/outputs/model.pkl
          MLProject/outputs/metrics.json
          mlflow_run_info.json
        tag_name: mlflow-run-${{ github.run_number }}
        name: MLflow Run ${{ github.run_number }}
        body: |
          MLflow Automated Training Run
          
          **Run ID:** ${{ env.RUN_ID }}
          **Workflow Run:** ${{ github.run_number }}
          **Trigger:** ${{ github.event_name }}
          
          **Artifacts:**
          - model.pkl: Trained ML model
          - metrics.json: Performance metrics
          - mlflow_run_info.json: Run metadata

  # DOCKER BUILD JOB
  docker-build-push:
    runs-on: ubuntu-latest
    name: Docker Image Build
    needs: ml-model-training
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    # 6. Build Docker Model (STEP TERPISAH)
    - name: Build Docker Model
      id: build-docker
      run: |
        echo "Building Docker image..."
        docker build -f MLProject/Dockerfile -t temp-diabetes-model:latest ./MLProject
        echo "Docker build completed"
        
    # 7. Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # 8. Tag Docker Image (STEP TERPISAH)
    - name: Tag Docker Image
      run: |
        echo "Tagging Docker image..."
        # Tag dengan multiple tags
        docker tag temp-diabetes-model:latest ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:latest
        docker tag temp-diabetes-model:latest ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:v${{ github.run_number }}
        docker tag temp-diabetes-model:latest ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:${{ env.RUN_ID }}
        
        echo "Tags created:"
        docker images | grep diabetes-ml-model
        
    # 9. Push Docker Image (STEP TERPISAH)
    - name: Push Docker Image
      run: |
        echo "Pushing Docker images to Docker Hub..."
        docker push ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:v${{ github.run_number }}
        docker push ${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:${{ env.RUN_ID }}
        echo "All images pushed successfully!"
        
    # 10. Post Log in to Docker Hub (cleanup)
    - name: Post Log in to Docker Hub
      run: |
        echo "Cleaning up Docker login..."
        docker logout
        
    # Create summary
    - name: Create Docker summary
      run: |
        echo "##  Docker Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Steps Completed:**" >> $GITHUB_STEP_SUMMARY
        echo "1.  Build Docker Model" >> $GITHUB_STEP_SUMMARY
        echo "2.  Log in to Docker Hub" >> $GITHUB_STEP_SUMMARY
        echo "3.  Tag Docker Image" >> $GITHUB_STEP_SUMMARY
        echo "4.  Push Docker Image" >> $GITHUB_STEP_SUMMARY
        echo "5.  Post Log in to Docker Hub" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Images Pushed:**" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:v${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ secrets.DOCKER_USERNAME }}/diabetes-ml-model:${{ env.RUN_ID }}\`" >> $GITHUB_STEP_SUMMARY